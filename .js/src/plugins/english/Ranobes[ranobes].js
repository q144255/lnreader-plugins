var t=this&&this.__assign||function(){return t=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var s in e=arguments[n])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},t.apply(this,arguments)},e=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(s,a){function i(t){try{c(r.next(t))}catch(t){a(t)}}function o(t){try{c(r.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,o)}c((r=r.apply(t,e||[])).next())}))},n=this&&this.__generator||function(t,e){var n,r,s,a,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(i=0)),i;)try{if(n=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(s=i.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){i.label=o[1];break}if(6===o[0]&&i.label<s[1]){i.label=s[1],s=o;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(o);break}s[2]&&i.ops.pop(),i.trys.pop();continue}o=e.call(t,i)}catch(t){o=[6,t],r=0}finally{n=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("htmlparser2"),s=require("@libs/fetch"),a=require("@libs/novelStatus"),i=new(function(){function i(t){var e=this;this.parseDate=function(t){var n=new Date;if(!t)return n.toISOString();if("ranobes-ru"===e.id){if(t.includes(" в "))return t.replace(" в "," г., ");var r=t.split(", "),s=r[0],a=r[1];if(!a)return n.toISOString();var i=a.split(":"),o=i[0],c=i[1];switch(s){case"Сегодня":n.setHours(parseInt(o,10)),n.setMinutes(parseInt(c,10));break;case"Вчера":n.setDate(n.getDate()-1),n.setHours(parseInt(o,10)),n.setMinutes(parseInt(c,10));break;default:return n.toISOString()}}else{var u=t.split(" "),l=u[0],p=u[1];if("ago"!==u[2])return n.toISOString();switch(p){case"minutes":n.setMinutes(parseInt(l,10));break;case"hour":case"hours":n.setHours(parseInt(l,10));break;case"day":case"days":n.setDate(n.getDate()-parseInt(l,10));break;case"month":case"months":n.setMonth(n.getMonth()-parseInt(l,10));break;case"year":case"years":n.setFullYear(n.getFullYear()-parseInt(l,10));break;default:return n.toISOString()}}return n.toISOString()},this.id=t.id,this.name=t.sourceName,this.icon="multisrc/ranobes/ranobes/icon.png",this.site=t.sourceSite,this.version="2.0.1",this.options=t.options}return i.prototype.parseNovels=function(t){var e=[],n={name:""},s=this.site,a=!1,i=!1,o=!1,c=new r.Parser({onopentag:function(t,r){var c,u;(null===(c=r.class)||void 0===c?void 0:c.includes("short-cont"))&&(a=!0),a&&("h2"===t&&(null===(u=r.class)||void 0===u?void 0:u.includes("title"))&&(i=!0),i&&"a"===t&&(n.path=r.href.slice(s.length),o=!0),"figure"===t&&(n.cover=r.style.replace(/.*url\((.*?)\)./g,"$1")),n.path&&n.cover&&(e.push(n),(n={}).name=""))},ontext:function(t){o&&(n.name+=t)},onclosetag:function(t){"h2"===t&&(o=!1,i=!1),"figure"===t&&(a=!1)}});return c.write(t),c.end(),e},i.prototype.parseChapters=function(t){var e=this,n=[];return t.chapters.map((function(t){n.push({name:t.title,releaseTime:new Date(t.date).toISOString(),path:t.link.slice(e.site.length)})})),n.reverse()},i.prototype.popularNovels=function(t){return e(this,void 0,void 0,(function(){var e,r;return n(this,(function(n){switch(n.label){case 0:return e="".concat(this.site,"/").concat(this.options.path,"/page/").concat(t,"/"),[4,(0,s.fetchApi)(e).then((function(t){return t.text()}))];case 1:return r=n.sent(),[2,this.parseNovels(r)]}}))}))},i.prototype.parseNovel=function(i){return e(this,void 0,void 0,(function(){var e,o,c,u,l,p,h,f,d,v,g,m,b,y,w,S,x,_,O,I;return n(this,(function(n){switch(n.label){case 0:return e=this.site,[4,(0,s.fetchApi)(e+i)];case 1:return[4,n.sent().text()];case 2:return o=n.sent(),c={path:i,name:"",summary:"",chapters:[],totalPages:1},u=!1,l=!1,p=!1,h=!1,f=!1,d=!1,v=!1,g=!1,m=!1,b=!1,y=!1,w=[],S=[],x={},_=0,O=this.parseDate,(I=new r.Parser({onopentag:function(t,n){"poster"===n.class&&(u=!0),u&&"img"===t&&(c.name=n.alt,c.cover=e+n.src),("div"===t&&"moreless cont-text showcont-h"===n.class||"cont-text showcont-h"===n.class&&"description"===n.itemprop)&&(p=!0),"li"===t&&n.title&&(n.title.includes("Original status")||n.title.includes("Статус оригинала"))&&(h=!0),"a"===t&&"chapter"===n.rel&&(m=!0,x.path=n.href.replace(e,"")),m&&"span"===t&&"title ellipses"===n.class&&(b=!0),m&&"span"===t&&"grey"===n.class&&(y=!0),"li"!==t||"Glossary + illustrations + division of chapters, etc."!=n.title&&"Глоссарий + иллюстраций + разделение глав и т.д."!==n.title||(g=!0)},onopentagname:function(t){p&&"br"===t&&(c.summary+="\n"),h&&"a"===t&&(f=!0),d&&"a"===t&&(v=!0)},onattribute:function(t,e){"itemprop"===t&&"creator"===e&&(l=!0),"id"===t&&"mc-fs-genre"===e&&(d=!0)},ontext:function(t){if(l&&(c.author=t),p&&(c.summary+=t.trim()),f&&(c.status="Ongoing"===t||"В процессе"==t?a.NovelStatus.Ongoing:a.NovelStatus.Completed),v&&w.push(t),g){var e=t.replace(/\D/g,"");e&&(_=parseInt(e,10))}m&&(b&&(x.name=t.trim()),y&&(x.releaseTime=O(t.trim())))},onclosetag:function(e){"a"===e&&(u=!1,l=!1,f=!1,v=!1,h=!1),"div"===e&&(p=!1,d=!1),"li"===e&&(g=!1),"a"===e&&(m=!1,x.name&&(S.push(t(t({},x),{page:"1"})),x={})),"span"===e&&(b&&(b=!1),y&&(y=!1))}})).write(o),I.end(),c.genres=w.join(", "),c.totalPages=Math.ceil((_||1)/25),c.chapters=S,c.chapters[0].path&&(c.latestChapter=c.chapters[0]),[2,c]}}))}))},i.prototype.parsePage=function(t,a){return e(this,void 0,void 0,(function(){var e,i,o,c,u,l,p,h,f,d,v,g,m,b;return n(this,(function(n){switch(n.label){case 0:return e="ranobes"==this.id?t.split("-")[0]:"/"+t.split("-").slice(1).join("-").split(".")[0],i=this.site+"/chapters"+e.replace(this.options.path+"/",""),[4,(0,s.fetchApi)(i+"/page/"+a).then((function(t){return t.text()}))];case 1:return o=n.sent(),c=this.site,u=!1,l=!1,p=!1,h=!1,f=[],d={},v=this.parseDate,g={pages_count:"",chapters:[]},(m=new r.Parser({onopentag:function(t,e){"div"===t&&"cat_block cat_line"===e.class&&(l=!0),l&&"a"===t&&e.title&&e.href&&(d.name=e.title,d.path=e.href.replace(c,"")),"span"===t&&"grey small"===e.class&&(p=!0),"small"===t&&p&&(h=!0)},ontext:function(t){h&&(d.releaseTime=v(t.trim())),u&&t.includes("window.__DATA__ =")&&(g=JSON.parse(t.replace("window.__DATA__ =","")))},onclosetag:function(t){"a"===t&&d.name&&(f.push(d),d={}),"div"===t&&(l=!1),"span"===t&&(p=!1),"small"===t&&(h=!1),"main"===t&&(u=!0),"script"===t&&(u=!1)}})).write(o),m.end(),(null===(b=g.chapters)||void 0===b?void 0:b.length)&&(f=this.parseChapters(g)),[2,{chapters:f}]}}))}))},i.prototype.parseChapter=function(t){return e(this,void 0,void 0,(function(){var e,r,a;return n(this,(function(n){switch(n.label){case 0:return[4,(0,s.fetchApi)(this.site+t)];case 1:return[4,n.sent().text()];case 2:return e=n.sent(),r=e.indexOf('<div class="text" id="arrticle">'),a=e.indexOf('<div class="category grey ellipses">',r),[2,e.substring(r,a)]}}))}))},i.prototype.searchNovels=function(t,r){return e(this,void 0,void 0,(function(){var e,a;return n(this,(function(n){switch(n.label){case 0:return"ranobes-ru"!==this.id?[3,2]:[4,(0,s.fetchApi)(this.site+"/index.php?do=search",{headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:this.site+"/"},method:"POST",body:new URLSearchParams({do:"search",subaction:"search",search_start:r.toString(),story:t}).toString()}).then((function(t){return t.text()}))];case 1:return e=n.sent(),[3,4];case 2:return a="".concat(this.site,"/search/").concat(t,"/page/").concat(r),[4,(0,s.fetchApi)(a).then((function(t){return t.text()}))];case 3:e=n.sent(),n.label=4;case 4:return[2,this.parseNovels(e)]}}))}))},i}())({id:"ranobes",sourceSite:"https://ranobes.top",sourceName:"Ranobes",options:{lang:"English",path:"novels"}});exports.default=i;